#!/bin/bash

### validate running as root
if [[ $(id -u) -ne 0 ]]; then echo "Please run as root."; exit 1; fi

### grant default user sudo without password
if ! grep -Fxq 'ubuntu ALL=(ALL) NOPASSWD:ALL' /etc/sudoers
then
    echo "ubuntu ALL=(ALL) NOPASSWD:ALL" | sudo tee -a /etc/sudoers
fi

### install pachages
apt-get -y update
apt-get -y upgrade

apt-get -y install vim
apt-get -y install git
apt-get -y install wget
apt-get -y install curl

# remote access
apt-get -y install openssh-server
apt-get -y install xrdp

apt-get -y update
apt-get -y upgrade

### enable services
systemctl enable --now ssh
systemctl enable --now xrdp

### adjust system firewall
ufw allow from 192.168.1.3/32 to any port 22
ufw allow from 192.168.1.2/32 to any port 3389 proto tcp

### configure xrdp fixes for known issues
sed -i 's%<allow_any>auth_admin</allow_any>%<allow_any>yes</auth_any>%g' /usr/share/polkit-1/actions/org.freedesktop.color.policy
sed -i 's%<allow_inactive>no</allow_inactive>%<allow_inactive>yes</auth_inactive>%g' /usr/share/polkit-1/actions/org.freedesktop.color.policy

echo "To pick up xrdp changes, please execute the following:"
echo -e "\tsystemctl restart xrdp"

