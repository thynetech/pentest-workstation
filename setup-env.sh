#!/bin/bash

# Change working directory to current directory of running script
cd "$(dirname "${BASH_SOURCE[0]}")" ; pwd -P > /dev/null
START_DIRECTORY=$( pwd )

### validate running as ubuntu
if [[ ! "$USER" == "ubuntu" ]]; then echo "Please run as ubuntu."; exit 1; fi

### grant remote access to the system
mkdir -p ~/.ssh
KEYS=$(curl https://github.com/devon-thyne.keys)
echo "" > /home/ubuntu/.ssh/authorized_keys
echo "$KEYS" > /home/ubuntu/.ssh/authorized_keys

### copy files
cp $START_DIRECTORY/files/* /home/ubuntu/files/


##### setup software
sudo apt-get -y update
sudo apt-get -y upgrade

### install pre-repos
sudo apt-get -y install software-properties-common

### setup repositories
sudo add-apt-repository -y universe
sudo add-apt-repository -y ppa:pi-rho/security
sudo add-apt-repository -y ppa:deadsnakes/ppa

### install packages
# basics
sudo apt-get -y install expect
sudo apt-get -y install unzip
sudo apt-get -y install htop
sudo apt-get -y install python3.7
sudo apt-get -y install python
sudo apt-get -y install docker.io
sudo snap -y install sublime-text

# misc
sudo apt-get -y install pssh
sudo apt-get -y install guake
sudo apt-get -y install xautomation
sudo apt-get -y install hexedit

# pentest-tools
sudo apt-get -y install nmap
sudo apt-get -y install hydra
sudo apt-get -y install wireshark
sudo apt-get -y install gobuster
sudo apt-get -y install john
sudo apt-get -y install sqlmap

sudo apt-get -y update
sudo apt-get -y upgrade


### download necessary content
mkdir -p /home/ubuntu/repos
mkdir -p /home/ubuntu/tools
mkdir -p /home/ubuntu/files
if ! grep -Fxq '### custom environment configurations' /home/ubuntu/.bashrc
then
    echo -e '\n\n### custom environment configurations\n' >> /home/ubuntu/.bashrc
fi
if ! grep -Fxq 'export PATH=$PATH:/home/ubuntu/tools' /home/ubuntu/.bashrc
then
    echo 'export PATH=$PATH:/home/ubuntu/tools' >> /home/ubuntu/.bashrc
fi
yes | cp -rf /home/ubuntu/.bashrc /home/ubuntu/.profile

# LinPEAS
cd /home/ubuntu/repos
if [[ ! -d /home/ubuntu/repos/privilege-escalation-awesome-scripts-suite ]]; then
    git clone https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite.git
else
    cd /home/ubuntu/repos/privilege-escalation-awesome-scripts-suite
    git pull
fi
yes | cp -rf /home/ubuntu/repos/privilege-escalation-awesome-scripts-suite/linPEAS/linpeas.sh /home/ubuntu/files/linpeas.sh

# LinEnum
cd /home/ubuntu/repos
if [[ ! -d /home/ubuntu/repos/LinEnum ]]; then
    git clone https://github.com/rebootuser/LinEnum.git
else
    cd /home/ubuntu/repos/LinEnum
    git pull
fi
yes | cp -rf /home/ubuntu/repos/LinEnum/LinEnum.sh /home/ubuntu/files/LinEnum.sh

# SecLists
cd /home/ubuntu/repos
if [[ ! -d /home/ubuntu/repos/SecLists ]]; then
    git clone https://github.com/danielmiessler/SecLists.git
else
    cd /home/ubuntu/repos/SecLists
    git pull
fi

# Kali Linus Tools
cd /home/ubuntu/repos
if [[ ! -d /home/ubuntu/repos/katoolin ]]; then
    git clone https://github.com/LionSec/katoolin.git
else
    cd /home/ubuntu/repos/katoolin
    git pull
fi
yes | sudo cp -rf /home/ubuntu/repos/katoolin/katoolin.py /usr/bin/katoolin
sudo chmod +x /usr/bin/katoolin

# poor-mans-pentest (John Hammond)
cd /home/ubuntu/repos
if [[ ! -d /home/ubuntu/repos/poor-mans-pentest ]]; then
    git clone https://github.com/JohnHammond/poor-mans-pentest.git
else
    cd /home/ubuntu/repos/poor-mans-pentest
    git pull
fi
sudo mkdir -p /opt/pmp
yes | sudo cp -rf /home/ubuntu/repos/poor-mans-pentest/functions.sh /opt/pmp/functions.sh
yes | cp -rf /home/ubuntu/repos/poor-mans-pentest/add_cron_job.sh /home/ubuntu/tools/add_cron_job
chmod +x /home/ubuntu/tools/add_cron_job
yes | cp -rf /home/ubuntu/repos/poor-mans-pentest/add_ssh_key.sh /home/ubuntu/tools/add_ssh_key
chmod +x /home/ubuntu/tools/add_ssh_key
yes | cp -rf /home/ubuntu/repos/poor-mans-pentest/download_file_nc.sh /home/ubuntu/tools/download_file_nc
chmod +x /home/ubuntu/tools/download_file_nc
yes | cp -rf /home/ubuntu/repos/poor-mans-pentest/stabilize_shell.sh /home/ubuntu/tools/stabilize_shell
chmod +x /home/ubuntu/tools/stabilize_shell
yes | cp -rf /home/ubuntu/repos/poor-mans-pentest/upload_file_nc.sh /home/ubuntu/tools/upload_file_nc
chmod +x /home/ubuntu/tools/upload_file_nc
yes | cp -rf /home/ubuntu/repos/poor-mans-pentest/upload_file_wget.sh /home/ubuntu/tools/upload_file_wget
chmod +x /home/ubuntu/tools/upload_file_wget

# pentestmonkey php-reverse-shell
cd /home/ubuntu/repos
if [[ ! -d /home/ubuntu/repos/php-reverse-shell ]]; then
    git clone https://github.com/pentestmonkey/php-reverse-shell.git
else
    cd /home/ubuntu/repos/php-reverse-shell
    git pull
fi
yes | cp -rf /home/ubuntu/repos/php-reverse-shell/php-reverse-shell.php /home/ubuntu/files/php-reverse-shell.php

# PayloadsAllTheThings
cd /home/ubuntu/repos
if [[ ! -d /home/ubuntu/repos/PayloadsAllTheThings ]]; then
    git clone https://github.com/swisskyrepo/PayloadsAllTheThings.git
else
    cd /home/ubuntu/repos/PayloadsAllTheThings
    git pull
fi

# ysoserial-multiarg
cd /home/ubuntu/tools
wget https://javadoc.jitpack.io/com/github/frohoff/ysoserial/multiarg-cf44df121a-1/ysoserial-multiarg-cf44df121a-1.jar -O ysoserial-multiarg.jar


### start services
sudo systemctl start docker
sudo systemctl enable docker

